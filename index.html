<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 é¦™æ¸¯è–èª•å››å¤©ä¸‰å¤œä¹‹æ—… (Dec 25-28)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        ::-webkit-scrollbar-thumb {
            background: #e11d48; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #be123c; 
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Map Link Styling */
        .map-link {
            color: #2563eb; /* blue-600 */
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .map-link:hover {
            color: #1d4ed8; /* blue-700 */
            background-color: #eff6ff; /* blue-50 */
        }
    </style>
</head>

<!-- ====== Admin Editor Modal ====== -->
<div id="editor-modal" class="hidden fixed inset-0 bg-black/40 z-[999] flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden border">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-800 text-white">
      <div class="font-bold">âœï¸ ç·¨è¼¯è¡Œç¨‹ï¼ˆDay <span id="ed-day-id"></span>ï¼‰</div>
      <button id="ed-close" class="text-xl leading-none">Ã—</button>
    </div>

    <div class="p-5 space-y-4 max-h-[75vh] overflow-y-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">title</label>
          <input id="ed-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">focus</label>
          <input id="ed-focus" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">morning_title</label>
          <input id="ed-morning-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">afternoon_title</label>
          <input id="ed-afternoon-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-500">morning_descï¼ˆå¯è²¼ HTMLï¼Œä¾‹å¦‚ createMapLink ç”¢å‡ºçš„ a é€£çµï¼‰</label>
        <textarea id="ed-morning-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">evening_title</label>
          <input id="ed-evening-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">notesï¼ˆç”¨ ; åˆ†éš”å¤šç­†ï¼‰</label>
          <input id="ed-notes" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-500">afternoon_desc</label>
        <textarea id="ed-afternoon-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div>
        <label class="text-xs text-slate-500">evening_desc</label>
        <textarea id="ed-evening-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div class="flex gap-2 justify-end pt-2">
        <button id="ed-cancel" class="px-4 py-2 rounded-lg border">å–æ¶ˆ</button>
        <button id="ed-save" class="px-4 py-2 rounded-lg bg-rose-600 text-white font-bold">å„²å­˜åˆ° Sheet</button>
      </div>
    </div>
  </div>
</div>

<!-- hidden iframe + form (avoid CORS) -->
<iframe name="save_iframe" class="hidden"></iframe>
<form id="save-form" method="POST" target="save_iframe" class="hidden">
  <input type="hidden" name="payload" id="payload" value="">
</form>

<body class="bg-stone-50 text-slate-800 font-sans leading-relaxed">

    <!-- Navigation / Header -->
    <header class="bg-white shadow-md border-b-4 border-rose-600 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-3xl">ğŸ…</span>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-rose-700 tracking-wide">é¦™æ¸¯è–èª•ä¹‹æ—…</h1>
                    <p class="text-xs text-slate-500 hidden md:block">Dec 25 - Dec 28, 2025</p>
                </div>
            </div>
            <nav class="hidden md:flex space-x-6 text-sm font-semibold text-slate-600">
                <a href="#itinerary" class="hover:text-rose-600 transition">è¡Œç¨‹è¦åŠƒ</a>
                <a href="#insights" class="hover:text-rose-600 transition">æ—…ç¨‹åˆ†æ</a>
                <a href="#food" class="hover:text-rose-600 transition">ç¾é£Ÿæ¸…å–®</a>
                <a href="#tips" class="hover:text-rose-600 transition">äº¤é€šèˆ‡ç¥¨åˆ¸</a>
            </nav>
            <button id="mobile-menu-btn" class="md:hidden text-2xl text-slate-600">â˜°</button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-stone-100 p-4 md:hidden border-t">
            <a href="#itinerary" class="block py-2 text-slate-700 hover:text-rose-600">è¡Œç¨‹è¦åŠƒ</a>
            <a href="#insights" class="block py-2 text-slate-700 hover:text-rose-600">æ—…ç¨‹åˆ†æ</a>
            <a href="#food" class="block py-2 text-slate-700 hover:text-rose-600">ç¾é£Ÿæ¸…å–®</a>
            <a href="#tips" class="block py-2 text-slate-700 hover:text-rose-600">äº¤é€šèˆ‡ç¥¨åˆ¸</a>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-rose-50 py-8">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">ğŸ„ è–èª•å¿«æ¨‚ï¼å››å¤©ä¸‰å¤œç²¾å½©è¡Œ</h2>
            <p class="max-w-2xl mx-auto text-slate-600 mb-4 text-sm">
                å¾é«˜éµå‡ºç™¼åˆ°ç¶­æ¸¯å¤œæ™¯ï¼Œè¿ªå£«å°¼å¥‡å¦™ä¸€æ—¥éŠï¼Œå†åˆ°æ—ºè§’æƒè¡—èˆ‡ç‡’éµç¾é£Ÿï¼Œæœ€å¾Œå¸¶è‘—æ»¿æ»¿çš„ Bakehouse è›‹å¡”å›å®¶ã€‚
            </p>
            <div class="flex flex-wrap justify-center gap-3 text-xs md:text-sm">
                <a href="https://www.google.com/maps/search/?api=1&query=é¦™æ¸¯è‹±çš‡é§¿æ™¯é…’åº—" target="_blank" class="bg-white px-3 py-1 rounded-full shadow-sm text-blue-600 font-semibold hover:bg-blue-50 transition">ğŸ¨ è‹±çš‡é§¿æ™¯é…’åº—</a>
                <a href="https://www.google.com/maps/search/?api=1&query=é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’" target="_blank" class="bg-white px-3 py-1 rounded-full shadow-sm text-pink-600 font-semibold hover:bg-pink-50 transition">ğŸ€ è¿ªå£«å°¼å…¨æ—¥</a>
                <a href="https://www.google.com/maps/search/?api=1&query=Bakehouse" target="_blank" class="bg-white px-3 py-1 rounded-full shadow-sm text-amber-600 font-semibold hover:bg-amber-50 transition">ğŸ¥§ è›‹å¡”ä¼´æ‰‹ç¦®</a>
            </div>
        </div>
    </section>

    <!-- Main Content Grid -->
    <main class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column: Itinerary -->
        <div class="lg:col-span-8 space-y-6" id="itinerary">
            
            <!-- Day Selector -->
            <div class="flex flex-wrap gap-2 md:gap-4 justify-center lg:justify-start">
                <button onclick="updateDay(1)" id="btn-day-1" class="day-btn px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold transition-all shadow-md bg-rose-600 text-white transform scale-105 text-sm md:text-base">12/25 æŠµé”èˆ‡è–èª•å¤œ</button>
                <button onclick="updateDay(2)" id="btn-day-2" class="day-btn px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold transition-all shadow-sm bg-white text-slate-600 hover:bg-rose-50 text-sm md:text-base">12/26 è¿ªå£«å°¼å¤¢å¹»</button>
                <button onclick="updateDay(3)" id="btn-day-3" class="day-btn px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold transition-all shadow-sm bg-white text-slate-600 hover:bg-rose-50 text-sm md:text-base">12/27 æ—ºè§’èˆ‡å¤ªå¹³å±±</button>
                <button onclick="updateDay(4)" id="btn-day-4" class="day-btn px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold transition-all shadow-sm bg-white text-slate-600 hover:bg-rose-50 text-sm md:text-base">12/28 ç‡’éµèˆ‡è¿”ç¨‹</button>
                <button id="btn-open-editor"
            class="px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold bg-slate-800 text-white hover:bg-slate-700 transition text-sm md:text-base">
            âœï¸ ç·¨è¼¯è¡Œç¨‹
            </button>
            </div>

            <!-- Dynamic Day Content Area -->
            <div id="day-content" class="bg-white rounded-2xl shadow-lg overflow-hidden min-h-[500px] fade-in relative border border-slate-100">
                <!-- Header -->
                <div class="bg-slate-800 text-white p-5 md:p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 text-9xl opacity-10 transform translate-x-4 -translate-y-4">âœˆï¸</div>
                    <h2 id="day-title" class="text-xl md:text-2xl font-bold mb-1 relative z-10">è¼‰å…¥ä¸­...</h2>
                    <p id="day-focus" class="text-emerald-300 font-medium text-sm md:text-base relative z-10">é‡é»ï¼šè¼‰å…¥ä¸­...</p>
                </div>

                <!-- Timeline Content -->
                <div class="p-5 md:p-6 space-y-6">
                    
                    <!-- Morning -->
                    <div class="relative pl-6 md:pl-8 border-l-2 border-rose-200">
                        <div class="absolute -left-2.5 top-0 w-5 h-5 bg-rose-500 rounded-full border-4 border-white"></div>
                        <h4 class="text-base md:text-lg font-bold text-rose-700 mb-2">å‡ºç™¼ï¼šæ¡ƒåœ’ âœˆï¸ é¦™æ¸¯</h4>
                        <div id="morning-content" class="text-slate-600 space-y-2 text-sm md:text-base"></div>
                    </div>

                    <!-- Afternoon -->
                    <div class="relative pl-6 md:pl-8 border-l-2 border-indigo-200">
                        <div class="absolute -left-2.5 top-0 w-5 h-5 bg-indigo-500 rounded-full border-4 border-white"></div>
                        <h4 class="text-base md:text-lg font-bold text-indigo-700 mb-2">ä¸‹åˆï¼šé…’åº— Check-in èˆ‡å®å®è»Š</h4>
                        <div id="afternoon-content" class="text-slate-600 space-y-2 text-sm md:text-base"></div>
                    </div>

                    <!-- Evening -->
                    <div class="relative pl-6 md:pl-8 border-l-2 border-purple-200">
                        <div class="absolute -left-2.5 top-0 w-5 h-5 bg-purple-500 rounded-full border-4 border-white"></div>
                        <h4 class="text-base md:text-lg font-bold text-purple-700 mb-2">æ™šä¸Šï¼šå°–æ²™å’€èˆ‡è˜­æ¡‚åŠ</h4>
                        <div id="evening-content" class="text-slate-600 space-y-2 text-sm md:text-base"></div>
                    </div>

                    <!-- Notes/Tickets -->
                    <div id="notes-container" class="hidden mt-6 bg-amber-50 p-4 rounded-lg border border-amber-100">
                        <h5 class="font-bold text-amber-800 mb-2 flex items-center"><span class="mr-2">ğŸŸï¸</span> ç¥¨åˆ¸èˆ‡å‚™è¨»ï¼š</h5>
                        <div id="notes-content" class="text-sm text-slate-700 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Right Column: Dashboard & Interactive Tools -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Insight Section -->
            <div id="insights" class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 border-b pb-2 mb-3">ğŸ“Š è¡Œç¨‹æ¦‚è¦½</h3>

                <!-- Chart 1 -->
                <div class="mb-6">
                    <h4 class="text-xs font-semibold text-rose-600 mb-2 text-center uppercase tracking-wider">æ´»å‹•é¡å‹åˆ†ä½ˆ</h4>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2 -->
                <div>
                    <h4 class="text-xs font-semibold text-rose-600 mb-2 text-center uppercase tracking-wider">ç¾é£Ÿé‡é»</h4>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="foodChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Foodie Checklist -->
            <div id="food" class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-amber-400">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center">
                    <span class="mr-2">ğŸ½ï¸</span> å¿…åƒç¾é£Ÿæ¸…å–®
                </h3>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-4" id="food-filters">
                    <button onclick="filterFood('all')" class="text-xs bg-slate-800 text-white px-3 py-1 rounded-full hover:bg-slate-700 transition">å…¨éƒ¨</button>
                    <button onclick="filterFood('roast')" class="text-xs bg-red-100 text-red-800 px-3 py-1 rounded-full hover:bg-red-200 transition">ç‡’éµ</button>
                    <button onclick="filterFood('bakery')" class="text-xs bg-amber-100 text-amber-800 px-3 py-1 rounded-full hover:bg-amber-200 transition">è›‹å¡”/çƒ˜ç„™</button>
                    <button onclick="filterFood('local')" class="text-xs bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full hover:bg-emerald-200 transition">åœ°é“å°åƒ</button>
                </div>

                <!-- List Container -->
                <ul id="food-list" class="space-y-2 max-h-80 overflow-y-auto pr-2 text-sm text-slate-700 custom-scrollbar">
                    <!-- Populated by JS -->
                </ul>
            </div>

        </div>

        <!-- Bottom Full Width: Transport & Tips -->
        <div id="tips" class="lg:col-span-12">
            <div class="bg-indigo-50 rounded-xl p-6 md:p-8 border border-indigo-100">
                <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                    <span class="bg-indigo-200 text-indigo-800 p-2 rounded-lg mr-3">ğŸš‡</span> 
                    äº¤é€šèˆ‡å¯¦ç”¨è³‡è¨Š
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-indigo-700 mb-2">ğŸš„ æ©Ÿå ´å¿«ç·š</h4>
                        <p class="text-sm text-slate-600">
                            <a href="https://www.google.com/maps/search/?api=1&query=é¦™æ¸¯åœ‹éš›æ©Ÿå ´" target="_blank" class="map-link">æ©Ÿå ´</a> â†” 
                            <a href="https://www.google.com/maps/search/?api=1&query=é¦™æ¸¯ç«™" target="_blank" class="map-link">é¦™æ¸¯ç«™</a> (ç´„24åˆ†é˜)ã€‚<br>
                            è¨˜å¾—æª¢æŸ¥æ‰‹æ©Ÿå…§çš„ PDF ç¥¨åˆ¸ã€‚
                        </p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-indigo-700 mb-2">ğŸšƒ å®å®è»Š (é›»è»Š)</h4>
                        <p class="text-sm text-slate-600">
                            ä¸Šè»Šï¼š<a href="https://www.google.com/maps/search/?api=1&query=è–è‹¥ç‘Ÿå°å­¸+é›»è»Šç«™" target="_blank" class="map-link">è–è‹¥ç‘Ÿå°å­¸</a> æˆ– 
                            <a href="https://www.google.com/maps/search/?api=1&query=å·´è·¯å£«è¡—+é›»è»Šç«™" target="_blank" class="map-link">å·´è·¯å£«è¡—</a>ã€‚<br>
                            ä¸‹è»Šï¼š<a href="https://www.google.com/maps/search/?api=1&query=è²æ—æ˜é“+é›»è»Šç«™" target="_blank" class="map-link">è²æ—æ˜é“</a>ã€‚
                        </p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-indigo-700 mb-2">ğŸ¥§ Bakehouse åˆ†åº—è³‡è¨Š</h4>
                        <ul class="text-xs text-slate-600 space-y-1">
                            <li><strong>éŠ…é‘¼ç£:</strong> 08:00-21:00</li>
                            <li><strong>ä¸­ç’°:</strong> 08:00-21:00</li>
                            <li><strong>å°–æ²™å’€:</strong> 08:00-21:00</li>
                            <li><strong>ç£ä»”:</strong> 08:00-21:00</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-slate-800 text-slate-400 py-8 text-center text-sm">
        <p>ç¥æ‚¨æœ‰ä¸€å€‹æ„‰å¿«çš„é¦™æ¸¯ä¹‹æ—…ï¼ ğŸ…</p>
        <p class="mt-2 text-xs">Based on user itinerary: Dec 25 - Dec 28, 2025</p>
    </footer>

    <script>
        // Helper to create Google Maps Link
        function createMapLink(text, query) {
            const searchQuery = query || text;
            return `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}" target="_blank" class="map-link" title="åœ¨ Google Maps é–‹å•Ÿ">${text}</a>`;
        }

        // ====== âœ… ä½ åªè¦æ”¹é€™ 3 å€‹å€¼ ======
        // Google Sheet ç¶²å€æ ¼å¼ï¼š
        // https://docs.google.com/spreadsheets/d/ã€SHEET_IDã€‘/edit#gid=ã€GIDã€‘
        const SHEET_ID = "1NmDn4kLVfYnaweW4pAnaY7urcYPCpca2yYM3XXuCBOQ";
        const DAYS_GID  = "0";
        const FOOD_GID  = "1262044602";

        // --- DATA STORAGE ---
        // é€™è£¡æ”¹æˆç©ºï¼Œè³‡æ–™ç”± Google Sheet è¼‰å…¥
        const tripData = { days: [], food: [] };

        // --- CSV Loader (Google Sheet -> CSV) ---
        function parseCSV(text) {
            const rows = text.trim().split("\n").map(line => {
                const out = [];
                let cur = "", inQ = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') inQ = !inQ;
                    else if (ch === "," && !inQ) { out.push(cur); cur = ""; }
                    else cur += ch;
                }
                out.push(cur);
                return out.map(s => s.replace(/^"|"$/g, "").replace(/""/g, '"'));
            });
            return rows;
        }

        async function loadSheetCSV(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
            const res = await fetch(url, { cache: "no-store" });
            return await res.text();
        }

        async function loadTripDataFromSheet() {
            try {
                // days
                const daysCSV = await loadSheetCSV(DAYS_GID);
                const daysRows = parseCSV(daysCSV);
                const daysHeaders = daysRows.shift().map(h => h.trim());

                const days = daysRows.map(r => {
                    const obj = Object.fromEntries(daysHeaders.map((h,i)=>[h, (r[i] ?? "").trim()]));
                    return {
                        id: Number(obj.id),
                        title: obj.title,
                        focus: obj.focus,
                        color: obj.color || "rose",
                        morning: { title: obj.morning_title, desc: obj.morning_desc },
                        afternoon: { title: obj.afternoon_title, desc: obj.afternoon_desc },
                        evening: { title: obj.evening_title, desc: obj.evening_desc },
                        notes: (obj.notes || "").split(";").map(s => s.trim()).filter(Boolean)
                    };
                }).sort((a,b)=>a.id-b.id);

                // food
                const foodCSV = await loadSheetCSV(FOOD_GID);
                const foodRows = parseCSV(foodCSV);
                const foodHeaders = foodRows.shift().map(h => h.trim());

                const food = foodRows.map(r => {
                    const obj = Object.fromEntries(foodHeaders.map((h,i)=>[h, (r[i] ?? "").trim()]));
                    return {
                        name: obj.name,
                        category: obj.category,
                        label: obj.label,
                        query: obj.query
                    };
                });

                tripData.days = days;
                tripData.food = food;

            } catch (err) {
                console.error(err);
                alert("è¼‰å…¥ Google Sheet å¤±æ•—ï¼šè«‹ç¢ºèª Sheet å·²è¨­æˆã€çŸ¥é“é€£çµçš„äººå¯æª¢è¦–ã€ï¼Œä»¥åŠ SHEET_ID / GID æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }

        // --- CORE LOGIC ---
        function updateDay(dayId) {
            if (!tripData.days || tripData.days.length === 0) return;

            // 1. Update Buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('bg-rose-600', 'text-white', 'scale-105', 'shadow-md');
                btn.classList.add('bg-white', 'text-slate-600', 'hover:bg-rose-50');
            });
            const activeBtn = document.getElementById(`btn-day-${dayId}`);
            activeBtn.classList.remove('bg-white', 'text-slate-600', 'hover:bg-rose-50');
            activeBtn.classList.add('bg-rose-600', 'text-white', 'scale-105', 'shadow-md');

            // 2. Retrieve Data
            const day = tripData.days.find(d => d.id === dayId);
            if (!day) return;
            
            // 3. Update Content
            const contentContainer = document.getElementById('day-content');
            contentContainer.classList.remove('fade-in');
            void contentContainer.offsetWidth; 
            contentContainer.classList.add('fade-in');

            document.getElementById('day-title').textContent = day.title || "";
            document.getElementById('day-focus').textContent = day.focus || "";
            
            // Set Sections
            const morningDiv = document.getElementById('morning-content');
            morningDiv.parentElement.querySelector('h4').innerHTML = day.morning?.title || "";
            morningDiv.innerHTML = day.morning?.desc || "";

            const afternoonDiv = document.getElementById('afternoon-content');
            afternoonDiv.parentElement.querySelector('h4').innerHTML = day.afternoon?.title || "";
            afternoonDiv.innerHTML = day.afternoon?.desc || "";

            const eveningDiv = document.getElementById('evening-content');
            eveningDiv.parentElement.querySelector('h4').innerHTML = day.evening?.title || "";
            eveningDiv.innerHTML = day.evening?.desc || "";

            // Set Notes
            const notesContainer = document.getElementById('notes-container');
            const notesContent = document.getElementById('notes-content');
            notesContent.innerHTML = ''; 

            if (day.notes && day.notes.length > 0) {
                notesContainer.classList.remove('hidden');
                day.notes.forEach(note => {
                    const span = document.createElement('div');
                    span.className = "flex items-center bg-white px-2 py-1 rounded border border-amber-200";
                    span.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-amber-500 mr-2"></span>${note}`;
                    notesContent.appendChild(span);
                });
            } else {
                notesContainer.classList.add('hidden');
            }
        }

        function filterFood(filter) {
            const list = document.getElementById('food-list');
            list.innerHTML = ''; 

            const filteredItems = filter === 'all' 
                ? tripData.food 
                : tripData.food.filter(item => item.category === filter);

            filteredItems.forEach(item => {
                const li = document.createElement('a');
                li.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.query || item.name)}`;
                li.target = "_blank";
                li.className = "flex items-center p-3 rounded-lg hover:bg-stone-50 transition border border-transparent hover:border-rose-100 cursor-pointer group";
                li.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-rose-400 mr-3 shrink-0 group-hover:bg-rose-600 transition"></span>
                    <span class="font-medium flex-1 text-slate-800 group-hover:text-rose-700 transition">${item.name}</span>
                    <span class="text-xs text-rose-600 bg-rose-50 border border-rose-100 px-2 py-0.5 rounded-full whitespace-nowrap">${item.label}</span>
                `;
                list.appendChild(li);
            });
        }

        // --- CHARTS (Same as before) ---
        function initCharts() {
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['è¿ªå£«å°¼', 'è³¼ç‰©/ä¼´æ‰‹ç¦®', 'ç¾é£Ÿ/é¤å»³', 'äº¤é€š/è§€å…‰'],
                    datasets: [{
                        data: [25, 20, 30, 25],
                        backgroundColor: ['#f472b6', '#fbbf24', '#f87171', '#60a5fa'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 6 } } }
                }
            });

            const foodCtx = document.getElementById('foodChart').getContext('2d');
            new Chart(foodCtx, {
                type: 'bar',
                data: {
                    labels: ['é»å¿ƒ/éºµé£Ÿ', 'ç‡’éµ', 'è›‹å¡”/çƒ˜ç„™', 'èŒ¶é¤å»³'],
                    datasets: [{
                        label: 'åº—å®¶æ•¸é‡',
                        data: [2, 2, 2, 1],
                        backgroundColor: ['#fb923c', '#ef4444', '#fcd34d', '#34d399'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        window.addEventListener('DOMContentLoaded', async () => {
            await loadTripDataFromSheet();
            updateDay(1);
            filterFood('all');
            initCharts();
        });
        // ====== Web App URLï¼ˆå·²å¡«å…¥ä½ çš„ Apps Script Web Appï¼‰======
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzsxK3SI7B1iQLxnwoBWWK5Hzqm-h32QJPvlnWHlSlO66GYDlmdOxzCWD2mwFfMIXpYPQ/exec";

        // è®“ form æŒ‡å‘ webapp
        document.getElementById("save-form").action = WEBAPP_URL;

        // ç·¨è¼¯ç”¨ tokenï¼ˆä¸è¦å¯«æ­»åœ¨ HTMLï¼Œé¿å…è¢«çœ‹ sourceï¼‰
        let ADMIN_TOKEN = "";
        let CURRENT_EDIT_DAY_ID = 1;

        function openEditor(dayId) {
        const day = tripData.days.find(d => d.id === dayId);
        if (!day) return alert("æ‰¾ä¸åˆ° Day " + dayId);

        CURRENT_EDIT_DAY_ID = dayId;

        document.getElementById("ed-day-id").textContent = String(dayId);
        document.getElementById("ed-title").value = day.title || "";
        document.getElementById("ed-focus").value = day.focus || "";
        document.getElementById("ed-morning-title").value = day.morning?.title || "";
        document.getElementById("ed-morning-desc").value = day.morning?.desc || "";
        document.getElementById("ed-afternoon-title").value = day.afternoon?.title || "";
        document.getElementById("ed-afternoon-desc").value = day.afternoon?.desc || "";
        document.getElementById("ed-evening-title").value = day.evening?.title || "";
        document.getElementById("ed-evening-desc").value = day.evening?.desc || "";
        document.getElementById("ed-notes").value = (day.notes || []).join(";");

        document.getElementById("editor-modal").classList.remove("hidden");
        }

        function closeEditor() {
        document.getElementById("editor-modal").classList.add("hidden");
        }

        document.getElementById("btn-open-editor").addEventListener("click", () => {
        if (!ADMIN_TOKEN) {
            ADMIN_TOKEN = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼ˆTOKENï¼‰");
            if (!ADMIN_TOKEN) return;
        }
        openEditor(CURRENT_EDIT_DAY_ID || 1);
        });

        document.getElementById("ed-close").addEventListener("click", closeEditor);
        document.getElementById("ed-cancel").addEventListener("click", closeEditor);

        // è®“ã€Œç›®å‰ dayã€è·Ÿè‘—åˆ‡æ›
        const _origUpdateDay = updateDay;
        updateDay = function(dayId){
        CURRENT_EDIT_DAY_ID = dayId;
        _origUpdateDay(dayId);
        };

        // å„²å­˜ï¼šæ›´æ–°ç•«é¢ + å¯«å› Sheet
        document.getElementById("ed-save").addEventListener("click", async () => {
        if (!ADMIN_TOKEN) {
            ADMIN_TOKEN = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼ˆTOKENï¼‰");
            if (!ADMIN_TOKEN) return;
        }

        const dayId = CURRENT_EDIT_DAY_ID;

        const fields = {
            title: document.getElementById("ed-title").value,
            focus: document.getElementById("ed-focus").value,
            morning_title: document.getElementById("ed-morning-title").value,
            morning_desc: document.getElementById("ed-morning-desc").value,
            afternoon_title: document.getElementById("ed-afternoon-title").value,
            afternoon_desc: document.getElementById("ed-afternoon-desc").value,
            evening_title: document.getElementById("ed-evening-title").value,
            evening_desc: document.getElementById("ed-evening-desc").value,
            notes: document.getElementById("ed-notes").value
        };

        // 1) å…ˆæ›´æ–°æœ¬æ©Ÿè³‡æ–™ï¼Œç•«é¢ç«‹åˆ»æ”¹
        const day = tripData.days.find(d => d.id === dayId);
        if (day) {
            day.title = fields.title;
            day.focus = fields.focus;
            day.morning.title = fields.morning_title;
            day.morning.desc = fields.morning_desc;
            day.afternoon.title = fields.afternoon_title;
            day.afternoon.desc = fields.afternoon_desc;
            day.evening.title = fields.evening_title;
            day.evening.desc = fields.evening_desc;
            day.notes = (fields.notes || "").split(";").map(s=>s.trim()).filter(Boolean);
            updateDay(dayId);
        }

        // 2) é€åˆ° Apps Script å¯«å› Sheetï¼ˆç”¨ hidden form submit é¿å… CORSï¼‰
        const payloadObj = {
            token: ADMIN_TOKEN,
            op: "update_day",
            dayId: String(dayId),
            fields
        };

        document.getElementById("payload").value = JSON.stringify(payloadObj);
        document.getElementById("save-form").submit();

        alert("å·²é€å‡ºå„²å­˜ï¼ˆåˆ·æ–°é é¢å³å¯çœ‹åˆ° Sheet æœ€æ–°å…§å®¹ï¼‰");
        closeEditor();

        // 3) å¯é¸ï¼šé‡æ–°è®€ Sheet ä»¥ç¢ºä¿ä¸€è‡´
        try {
            await loadTripDataFromSheet();
            updateDay(dayId);
            filterFood('all');
        } catch(e) {}
        });


    </script>
    <!-- ====== Admin Editor Modal ====== -->
<div id="editor-modal" class="hidden fixed inset-0 bg-black/40 z-[999] flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden border">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-800 text-white">
      <div class="font-bold">âœï¸ ç·¨è¼¯è¡Œç¨‹ï¼ˆDay <span id="ed-day-id"></span>ï¼‰</div>
      <button id="ed-close" class="text-xl leading-none">Ã—</button>
    </div>

    <div class="p-5 space-y-4 max-h-[75vh] overflow-y-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">title</label>
          <input id="ed-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">focus</label>
          <input id="ed-focus" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">morning_title</label>
          <input id="ed-morning-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">afternoon_title</label>
          <input id="ed-afternoon-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-500">morning_descï¼ˆå¯è²¼ HTMLï¼Œä¾‹å¦‚ a é€£çµï¼‰</label>
        <textarea id="ed-morning-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-500">evening_title</label>
          <input id="ed-evening-title" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="text-xs text-slate-500">notesï¼ˆç”¨ ; åˆ†éš”å¤šç­†ï¼‰</label>
          <input id="ed-notes" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div>
        <label class="text-xs text-slate-500">afternoon_desc</label>
        <textarea id="ed-afternoon-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div>
        <label class="text-xs text-slate-500">evening_desc</label>
        <textarea id="ed-evening-desc" class="w-full border rounded-lg px-3 py-2 min-h-[90px]"></textarea>
      </div>

      <div class="flex gap-2 justify-end pt-2">
        <button id="ed-cancel" class="px-4 py-2 rounded-lg border">å–æ¶ˆ</button>
        <button id="ed-save" class="px-4 py-2 rounded-lg bg-rose-600 text-white font-bold">å„²å­˜åˆ° Sheet</button>
      </div>
    </div>
  </div>
</div>

<!-- hidden iframe + form (avoid CORS) -->
<iframe name="save_iframe" class="hidden"></iframe>
<form id="save-form" method="POST" target="save_iframe" class="hidden">
  <input type="hidden" name="payload" id="payload" value="">
</form>

</body>
</html>
